# This file is part of the Fuzion language implementation.
#
# The Fuzion language implementation is free software: you can redistribute it
# and/or modify it under the terms of the GNU General Public License as published
# by the Free Software Foundation, version 3 of the License.
#
# The Fuzion language implementation is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public
# License for more details.
#
# You should have received a copy of the GNU General Public License along with The
# Fuzion language implementation.  If not, see <https://www.gnu.org/licenses/>.


# -----------------------------------------------------------------------
#
#  Tokiwa Software GmbH, Germany
#
#  Source code of Fuzion standard library feature net.client
#
# -----------------------------------------------------------------------



# establish a new connection
# any active connection will be closed
# this call may block until connection is establised.
# NYI blocking / none blocking
#
client(addr Sequence u8, port u16)
is

  (connection client).close

  # open socket
  match fuzion.sys.net0.socket (family.family_of addr) socket_type.stream
    sd i64 =>
      port_addr array u8 := (port.as_bytes ++ addr).as_array
      # connect to addr, port
      res := fuzion.sys.net0.connect sd (family.family_of addr).as_num port_addr.internalArray.data port_addr.length
      if res != 0
        fuzion.sys.net0.close sd
        connection client (error "connecting client socket to addr {addr} port $port failed with error {res}.") effectMode.repl
      else
        connection client sd effectMode.repl
    con_err error =>
      connection client con_err effectMode.repl
  unit


